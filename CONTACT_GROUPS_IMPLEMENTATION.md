# 联系人分组功能实现文档

## 实现日期
2025-12-16

## 功能概述
实现了完整的联系人分组管理功能，参考原始 `手机流式.html` 中的分组实现，包括：
- 创建/重命名/删除分组
- 联系人拖拽到分组
- 分组折叠/展开
- 分组数据持久化

## 新增文件

### 1. 核心模块

#### `/src/scripts/storage/group-store.js`
联系人分组存储模块
- 管理分组数据（创建、更新、删除）
- 支持本地存储 + Tauri 持久化
- 提供分组排序、折叠状态管理
- 联系人在分组间移动

#### `/src/scripts/ui/group-panel.js`
分组管理面板
- 新建分组界面
- 分组列表显示
- 重命名/删除分组操作
- 与 `groupStore` 交互

#### `/src/scripts/ui/contact-drag-manager.js`
拖拽管理器
- 监听 dragstart、dragover、drop、dragend 事件
- 高亮拖拽目标区域
- 处理联系人在分组间移动
- 拖拽状态管理

#### `/src/scripts/ui/contact-group-renderer.js`
联系人分组渲染器
- 渲染分组结构（头部、内容区、放置区）
- 渲染未分组联系人
- 折叠/展开切换
- 与拖拽管理器集成

### 2. 样式文件

#### `/src/assets/css/contact-groups.css`
分组相关样式
- 分组容器、头部样式
- 折叠/展开动画
- 拖拽放置区样式
- 拖拽状态反馈
- 响应式适配

## 修改文件

### `/src/scripts/ui/app.js`
集成分组功能到主应用
- 导入分组相关模块
- 初始化 `GroupStore`、`ContactDragManager`、`GroupPanel`、`ContactGroupRenderer`
- 修改 `renderContactsUngrouped` 使用分组渲染器
- 连接"新建分组"按钮到 `GroupPanel`
- 拖拽后刷新联系人列表

### `/src/index.html`
引入分组样式
- 添加 `<link>` 标签引入 `contact-groups.css`

## 功能使用说明

### 创建分组
1. 点击联系人页面顶部的"+"按钮
2. 选择"新建分组"
3. 输入分组名称（最多15字符）
4. 点击"创建"或按 Enter

### 拖拽联系人到分组
1. 长按联系人项
2. 拖拽到目标分组的放置区（蓝色虚线区域）
3. 松开完成移动

### 折叠/展开分组
- 点击分组头部即可切换折叠/展开状态
- 折叠状态会自动保存

### 重命名分组
1. 打开分组管理面板
2. 点击分组右侧的"重命名"按钮
3. 输入新名称并确认

### 删除分组
1. 打开分组管理面板
2. 点击分组右侧的"删除"按钮
3. 确认删除
4. 分组中的联系人会移动到"未分组"区域

## 数据结构

### 分组对象
```javascript
{
  id: 'group_1234567890',      // 唯一标识
  name: '好友',                 // 分组名称
  contacts: ['user1', 'user2'], // 联系人ID数组
  collapsed: false,             // 是否折叠
  order: 0,                     // 排序序号
  createdAt: 1234567890,       // 创建时间
  updatedAt: 1234567890        // 更新时间
}
```

### 存储键
- localStorage: `contact_groups_v1`
- Tauri KV: `contact_groups_v1`

## 技术要点

### 拖拽实现
- 使用原生 HTML5 Drag and Drop API
- `draggable="true"` 属性启用拖拽
- 拖拽时高亮所有可放置区域
- 拖拽结束后自动刷新界面

### 数据持久化
- 优先使用 Tauri KV 存储（跨会话）
- 降级到 localStorage（浏览器环境）
- 修改后立即保存

### 渲染优化
- 使用 `ContactGroupRenderer` 统一渲染逻辑
- 复用联系人渲染函数（支持预览、时间）
- 折叠动画使用 CSS transition

## 与原始实现的差异

### 相同点
- 分组结构和交互逻辑一致
- 拖拽功能完全对应
- 折叠/展开/重命名/删除功能保持

### 不同点
- 使用模块化架构（vs 原始的单文件）
- 独立的存储层（vs 原始的世界书存储）
- 更简洁的 UI 设计
- 去除了分组拖拽排序（可后续添加）

## 后续可优化

1. **分组排序**：支持拖拽分组头部来调整分组顺序
2. **批量操作**：多选联系人同时移动到分组
3. **分组搜索**：在分组管理面板中搜索分组
4. **分组统计**：显示每个分组的消息数、未读数
5. **分组图标**：为分组添加自定义图标或颜色
6. **分组导入导出**：支持备份和恢复分组配置

## 测试建议

### 基础功能测试
- [ ] 创建分组（正常名称、空名称、重复名称）
- [ ] 重命名分组（正常、空名称、重复名称）
- [ ] 删除分组（空分组、有联系人的分组）
- [ ] 折叠/展开分组
- [ ] 拖拽联系人到分组
- [ ] 拖拽联系人到未分组区域
- [ ] 拖拽联系人到同一分组（应无变化）

### 数据持久化测试
- [ ] 刷新页面后分组保留
- [ ] 关闭应用重新打开后分组保留
- [ ] 折叠状态在刷新后保留

### 界面测试
- [ ] 分组头部点击响应
- [ ] 拖拽时放置区高亮
- [ ] 拖拽结束后状态恢复
- [ ] 分组面板打开/关闭动画
- [ ] 手机端触摸拖拽

### 边界情况测试
- [ ] 没有联系人时的显示
- [ ] 所有联系人都在分组中时的显示
- [ ] 快速连续创建/删除分组
- [ ] 快速连续拖拽联系人

## 相关文件索引

**核心文件**:
- `src/scripts/storage/group-store.js` - 分组数据管理
- `src/scripts/ui/group-panel.js` - 分组管理界面
- `src/scripts/ui/contact-drag-manager.js` - 拖拽逻辑
- `src/scripts/ui/contact-group-renderer.js` - 分组渲染
- `src/assets/css/contact-groups.css` - 分组样式

**集成文件**:
- `src/scripts/ui/app.js` - 主应用集成
- `src/index.html` - 样式引入

**参考文件**:
- `/mnt/d/my/phone/手机流式.html` (32729-33428行) - 原始分组实现
