# 開發進度追蹤（必更新）

## 架構簡表
- 前端殼：`src/index.html` + `assets/css/qq-legacy.css`（原版QQ樣式） + `assets/css/main.css`
- 交互邏輯：`src/scripts/ui/app.js`（整體協調）、`src/scripts/ui/chat/chat-ui.js`（渲染/輸入/打字）、`src/scripts/ui/config-panel.js`
- 橋接層：`src/scripts/ui/bridge.js`
- 客戶端與配置：`src/scripts/api/*`、`src/scripts/storage/config.js`、`src/scripts/storage/chat.js`
- 資產：`src/assets/**`（CSS/圖片等），`src/lib/**`（第三方）

## 變更日誌
- 2025-12-10
  - 建立進度追蹤文件，要求後續每次代碼更新同步記錄。
  - 重構 UI 殼：新增 `assets/css/chat.css`、改寫 `src/index.html`，引入模組化聊天界面。
  - 新增聊天 UI 模組：`src/scripts/ui/chat/chat-ui.js`（消息渲染、打字指示器、自適應輸入）。
  - 新增應用入口：`src/scripts/ui/app.js`，統一初始化橋接、配置面板入口、流式/非流式發送、歷史預載。
  - 更新 `MIGRATION_PLAN.md`：添加當前進度快照與下一步建議。
- 2025-12-10（續）
  - 加入消息解析器 `src/scripts/ui/chat/message-parser.js`，支持特例消息標記：[img-]、[yy-]、[music-]、[zz-]、[bqb-]。
  - 擴展聊天渲染：`chat-ui.js` 支持圖片、語音卡、音樂卡、轉帳提示、表情包徽標，流式完成後會用解析結果重渲染。
  - 新增卡片樣式：`assets/css/cards.css`，並在 `index.html` 引入。
  - 更新 `app.js`：流式/非流式流程都使用解析後的類型化消息。
- 2025-12-10 13:21
  - 添加資產提取/下載工具：`scripts/utils/extract-assets.js` 生成 `asset-manifest.json`、`asset-summary.txt`；`scripts/utils/download-assets.js` 用於批量下載（需網絡）。
  - 生成了初步資產清單（31 個 URL）。
  - 新增 `WORLDINFO_NOTES.md`：整理 ST 世界書格式、目標簡化格式與導入策略（僅參考，不改 ST 源）。
- 2025-12-10 13:23
  - 新增世界書存取與轉換：`src/scripts/storage/worldinfo.js`（localStorage 緩存，提供 ST JSON -> 簡化格式轉換）。
  - 更新 `bridge.js`：增加 worldStore；get/saveWorldInfo 先用本地存儲，後端命令存在則同步；新增 `window.importSTWorld` 兼容導入。
- 2025-12-10 13:25
  - 新增世界書面板 `src/scripts/ui/world-panel.js`：列出本地世界書、支持貼入 ST JSON 導入（使用 `convertSTWorld`）、可從頭部「世界书」按鈕打開。
  - 更新 `index.html`（新增世界书按鈕）、`app.js`（掛載世界書面板）、`bridge.js`（listWorlds/setCurrentWorld）。
- 2025-12-10 13:28
  - 世界書面板增強：列表項新增「啟用」（設置當前世界書並提示）與「導出」（優先複製到剪貼簿，退化為下載 JSON）。
- 2025-12-10 13:35
  - 資產下載（需網路）：`node scripts/utils/download-assets.js` 成功拉取約 21 個文件到 `src/assets/external`；大量 sharkpan/catbox 資源仍有 404/命名過長/占位符導致失敗，保留 `asset-manifest.json` 作為待補清單。
- 2025-12-10 13:36
  - 引入已下載背景示例：`main.css` 增加 `bg-legacy` 並在 `index.html` body 掛上，引用 `src/assets/external/sharkpan.xyz-f-eWhZ-00017-2763077315.png`。
- 2025-12-10 13:39
  - UI 提升：聊天氣泡加入頭像/名稱/時間區塊；`chat-ui.js` 支持 avatar/name 元資料，`app.js` 為 user/assistant 指定本地下載的頭像。
  - 新增卡片樣式文件引用：`assets/css/legacy-card.css`（預留本地圖集展示），`index.html` 引入。
- 2025-12-10 13:44
  - 聊天 composer 升級：增加快捷操作占位按鈕（圖片/音樂/轉帳/表情），樣式更新。
  - 氣泡佈局保留頭像/名稱結構並增加 messageBuffer 以備後續多會話存儲。
- 2025-12-10 13:45
  - 增加前端會話存儲：`src/scripts/storage/chat-store.js`（localStorage），支援消息追加與草稿保存。
  - `app.js` 接入 ChatStore，啟動時預載歷史/草稿；發送時同步寫入存儲；輸入變更即時保存草稿。
  - `chat-ui.js` 提供 `setInputText` / `onInputChange` 以便草稿同步。
- 2025-12-10 13:47
  - 會話標籤顯示：`index.html` 顯示當前 session id，`chat-ui.js` 暴露 `setSessionLabel`。
  - ChatStore 接入現有 UI，為後續多會話/群聊切換奠定基礎（目前單 session，草稿/歷史不丟失）。
- 2025-12-10 13:48
  - 新增會話面板：`src/scripts/ui/session-panel.js` 可列出/新建/切換會話，並刷新歷史/草稿、標記當前 session。
  - `index.html` 增加「會話」按鈕，`chat-ui.js` 支持 session button handler，`app.js` 掛載 SessionPanel。
- 2025-12-10 13:50
  - 會話面板增強：顯示最近消息摘要，支持重命名與刪除會話；切換時清空當前列表並載入目標會話歷史/草稿。
  - `chat-ui.js` 新增 `clearMessages`；ChatStore 增加 `delete`/`rename`/`getLastMessage`。
- 2025-12-10 13:53
  - 世界書應用：`bridge.js` 在構建消息時自動附加當前世界書的內容（按 priority 排序），由 `setCurrentWorld` 控制。
- 2025-12-10 13:55
  - 聊天訊息顯示補充：meta 支持時間、徽章樣式；user/assistant 消息自動帶當前時間。
  - SessionPanel 增強：摘要顯示、重命名/刪除行為，切換時清空並重載歷史/草稿。
- 2025-12-10 13:57
  - 會話列表排序/摘要：按最後消息時間降序，顯示簡短摘要與時間；SessionPanel UI 更新。
  - Session badge：為標題添加 session 標籤 ID，預留群聊/標識擴展。
- 2025-12-10 13:58
  - Composer 佈局調整：縱向排列快捷操作+輸入/發送；chat-scroll 啟用平滑滾動。
- 2025-12-10 14:00
  - 消息解析增強：支持 inline <img>、純 URL 的圖片/視頻後綴判定；badge/時間在 meta 顯示。
  - 氣泡 meta 可顯示 badge，為群聊/狀態標籤預留。
- 2025-12-10 14:02
  - 會話列表細節：按最後消息時間排序；UI 保持摘要/時間顯示，預留群聊/標籤。
- 2025-12-10 14:05
  - SessionPanel 補充「清空當前」按鈕，便於重置會話；排序依最後消息時間；摘要/時間繼續顯示。
- 2025-12-10 14:10
  - 快捷操作落地：圖片/音樂/轉帳/表情按鈕可輸入內容並作為用戶消息插入（帶時間、頭像）。
  - 為後續媒體卡片行為打基礎（當前使用 prompt 輸入 URL/文本）。
- 2025-12-10 14:13
  - 圖片預覽：消息中的圖片可點擊放大（lightbox）；預設預覽樣式添加。
  - 歷史回放支持 type/name/avatar/time/meta/badge，確保渲染一致。
- 2025-12-10 14:14
  - 音樂卡片初步：播放/暫停按鈕（若有 URL 即可播放，無 URL 提示失敗）。
  - 解析器支持 music 標記及 meta.artist，用於卡片展示。
- 2025-12-10 14:16
  - 轉帳卡片：展示金額並提供「確認收款」按鈕（UI 互動占位）。
- 2025-12-10 14:18
  - 表情選擇器：新增 `StickerPicker`（預置表情列表），與快捷「表情」按鈕打通，插入 sticker 類消息。
- 2025-12-10 14:19
  - 會話列表再優化：按最後消息時間排序，摘要+時間展示，並加入群聊標記（基於 ID 前綴）。
- 2025-12-10 14:24
  - Slash 命令占位：新增 `command-runner.js`，支持 /clear（清空當前會話）、/session（開啟會話面板）、/world（開啟世界書面板）。
- 2025-12-10 14:27
  - 快捷操作細節：圖片輸入提示支持 file/https；音樂卡片允許填寫音源 URL；會話時間顯示用本地化 HH:MM。
- 2025-12-10 14:27
  - 音樂卡片：播放/暫停基於 meta.url 判斷，無地址時提示；解析保留。
- 2025-12-10 14:29
  - 小清理：SessionPanel/快捷操作提示微調（無功能變化）。
- 2025-12-10 14:31
  - 鍵盤/底部適配：chat-scroll 增加 safe-bottom padding，兼容鍵盤。
  - 清空提示文案更新，提醒不可恢復。
- 2025-12-10 14:33
  - 媒體選取占位：新增 `MediaPicker`，圖片快捷操作走 URL 輸入回調；結構上預留 file 選取接口。
  - 圖片插入、表情插入均經 handler 統一寫入會話。
- 2025-12-10 14:36
  - 世界書指示器：新增 `WorldInfoIndicator`，掛載到標題顯示當前世界書（初始“未啟用”）。
  - 打開世界書面板時同步刷新指示器。
- 2025-12-10 14:36
  - worldinfo 切換事件：`setCurrentWorld` 會派發 `worldinfo-changed`，`app.js` 監聽更新指示器。
- 2025-12-10 14:37
  - Slash 命令擴充：新增 /export（導出當前會話到剪貼簿）、/rename（重命名當前會話並同步 UI）。命令解析支持參數。
  - Session change 事件：重命名後觸發 session-changed，UI 同步歷史/草稿與標籤。
- 2025-12-10 14:38
  - 命令新增：/worldset <id> 直接切換當前世界書。
- 2025-12-10 14:39
  - 命令新增：/exportworld 導出當前世界書 JSON 到剪貼簿。
- 2025-12-10 14:49
  - 會話列表摘要顯示更多字符（32），時間格式本地化；群聊標記保留。
  - 消息容器 min-width 修正，避免 meta/badge 擠壓。
- 2025-12-10 14:51
  - 世界書命令：新增 /worldlist（列出已存世界書），初始化時刷新世界書指示器；/worldset 持續可用。
- 2025-12-10 14:53
  - 世界書面板：啟用時派發 worldinfo-changed，同步指示器。
  - 音樂卡片：播放中更新按鈕文案並顯示 URL（如有），暫停時重置。
- 2025-12-10 14:56
  - 世界書面板新增「導出當前」按鈕，可複製/下載當前世界書；啟用時仍同步指示器。
  - 命令補充：/worldlist、/worldset、/exportworld；世界書操作有 UI + 命令雙入口。
- 2025-12-10 15:06
  - 標題區支持換行（flex-wrap），避免指示器/徽章擠壓。
- 2025-12-10 15:11
  - 表情選擇器升級：增加「最近」分組（localStorage 保存），雙欄呈現最近/全部。
  - 媒體快捷操作：支持本地圖片/音頻文件（Data URL 形式插入）；音樂快捷操作可選文件或 URL。
- 2025-12-10 15:11
  - 世界書面板：增加「輸入框切換」按鈕，可直接用名稱框切換；啟用/切換會派發 worldinfo-changed。
- 2025-12-10 15:16
  - 命令新增：/help 列出所有命令；命令集覆蓋 worldlist/worldset/exportworld/export/rename/clear/session/world 等。
- 2025-12-10 15:19
  - 兼容處理：標題指示器掛載時檢查元素存在，避免空指針；chat meta 样式保持。
- 2025-12-10 15:27
  - 音樂卡片微調：播放/暫停狀態更新（播放中文案、重置）；快速操作去掉占位註解。
- 2025-12-10 13:16
  - 添加資產提取腳本 `scripts/utils/extract-assets.js`，解析 `手机流式.html` 中外部 URL，生成 `asset-manifest.json` 與 `asset-summary.txt` 以準備資產本地化。
- 2025-12-10 15:40
  - MIGRATION_PLAN 新增「實施順序（帶 PS）」段落，固化工作順序與風險提示，便於後續按序推進。
- 2025-12-10 15:40
  - 音樂卡片加入狀態/進度顯示（播放中/暫停/播放完畢 + 00:00/總長度），轉帳卡片增加狀態行與收款時間標記。
  - 會話面板強化：當前會話高亮並標記「當前」，切換行為改為只發佈 `session-changed` 事件避免重複渲染。
  - 世界書面板顯示當前世界書、列表高亮當前並禁用啟用按鈕，啟用/輸入切換後自動刷新列表。
- 2025-12-10 19:32
  - 消息解析補充：識別以音頻後綴結尾的 URL（mp3/wav/ogg/m4a），自動渲染為音頻卡片；兼容 ST 口徑的 `[yy-]` 之外的直鏈音頻。
- 2025-12-10 22:43
  - 配置面板打磨：可顯示/隱藏 API Key，必填校驗 Base URL / API Key / 模型，保存/測試按鈕加入 loading 狀態並復用 appBridge 配置，避免誤操作；標題增加生效提示。
- 2025-12-10 22:44
  - 媒體健壯性：圖片失敗時提示並標記為破圖；音樂卡片對播放錯誤給出提示並重置狀態。
- 2025-12-10 22:45
  - 鍵盤/弱網體驗：輸入框聚焦自動滾動到底；新增全局錯誤 Banner 用於未配置 API 或發送失敗提示；發送報錯時會同時 toaster + banner 提示。
- 2025-12-10 22:56
  - 穩定性小補：忽略空消息渲染；語音 audio 加載錯誤給出提示。
- 2025-12-10 23:00
  - 網絡狀態提示：監聽 online/offline，離線時顯示錯誤 Banner，恢復時提示已連接，避免弱網無感。
- 2025-12-10 23:08
  - 發送保護：離線時禁用發送並提示；恢復網絡自動恢復發送按鈕；離線狀態下阻止發送流程，減少錯誤。
- 2025-12-10 23:10
  - 媒體/流式防護：破圖樣式標記；流式狀態標記，防止流式中途再次點擊發送；語音卡片加載錯誤提示（已補）。
- 2025-12-10 23:13
  - 錯誤提示可重試：全局 Banner 支持「重試」按鈕，發送失敗可一鍵重試；Banner 停留時間延長以便操作。
- 2025-12-10 23:15
  - 桥接層校驗：在生成前檢查在線狀態，離線直接報錯避免後端調用，與前端離線防護一致。
- 2025-12-10 23:19
  - 新增手機手動回歸清單 `TEST_CHECKLIST.md`，覆蓋消息/媒體、會話與世界書、配置校驗、網絡切換、鍵盤佈局等場景，便於真機驗證。
- 2025-12-11 01:44
  - 修復瀏覽器開發模式下的模組解析：去除 `@tauri-apps/api/core` 靜態導入，使用安全的 `safeInvoke`（檢查 `window.__TAURI__`），避免 dev server 報「Failed to resolve module specifier」。
- 2025-12-11 09:47
  - UI 還原原稿三頁結構：新增頂部導航（聊天/联系人/动态），左右為頭像與「＋」按鈕；世界書/配置/會話入口收納到頭像設定菜單；＋ 展開快捷菜單。
  - 新增頁面骨架：聊天頁保留現有聊天殼，联系人/动态頁先行占位；增補頂部/頁面/菜單樣式以貼近原 QQ 風布局。
- 2025-12-11 09:57
  - 導航位置還原到底部 Tab（聊天/联系人/动态），符合原手機流式布局；聊天頁左上頭像、右上「＋」保留。
  - 聊天列表入口：先顯示聊天列表，點擊項目進入會話並顯示聊天室；底部 Tab 切換恢復正常。
- 2025-12-11 09:58
  - 安全區適配：頂部/底部使用 safe-area 填充，避免與瀏海/狀態欄重疊；切換非聊天頁時自動回到聊天列表視圖，保持原版邏輯。
- 2025-12-11 10:02
  - 移除其餘 @tauri-apps/api/core 靜態導入，改為 safeInvoke，避免 Android dev 環境模組解析報錯；配置/聊天存儲均兼容非 Tauri 環境。
- 2025-12-11 10:04
  - 顶部安全区收紧约 3/4，避免过低；设置/快捷菜单定位到按钮旁，避免弹到右上角。
- 2025-12-11 10:05
  - 顶部再上移约一头像高度（调整 safe-area padding），以贴近手机状态栏下方的常规社交布局。
- 2025-12-11 10:06
  - 顶部继续上移约两个头像高度（减少 padding-top），进一步贴近状态栏位置。
- 2025-12-11 10:10
  - 顶部再上移（约三头像高度，clamp 保護），设置/快捷菜单增加标题与描述，布局改绝对定位并限定最小宽度，弹出贴近按钮。
- 2025-12-11 10:12
  - 再上移约半头像：仅保留顶部安全区并给 topbar 负 margin；头像菜单内「配置」改为「⚙ 设定」并继续触发配置面板。
- 2025-12-11 10:14
  - 顶部再上移（约两头像高度，负 margin 调整），贴近状态栏。
- 2025-12-11 10:17
  - 联系人/动态页顶端同步上移；弹出菜单改为 fixed 定位并跟随按钮位置（含滚动偏移），避免漂移。
- 2025-12-11 10:19
  - 弹出菜单位置贴近按钮（1px 距离）；配置面板填充改用面板作用域查询，修复「设定」点击报 null 的问题。
- 2025-12-11 10:21
  - 菜单进一步贴近按钮（取消额外距离）；配置面板在填充前若未创建将自动 createUI，避免元素为 null。
- 2025-12-11 10:23
  - 菜单定位函数化，按按钮 rect+scrollY 精确贴 1px；配置加载为空时回退默认，避免“provider 为 null”崩溃。
- 2025-12-11 10:25
  - 菜单上移约两头像高度（相对按钮偏移），进一步贴近按钮；配置面板加宽到 94% / 680px 以适配手机。
- 2025-12-11 10:27
  - 顶部高度恢复（topbar 负 margin -64）；配置面板进一步加宽至 96vw / 760px。
- 2025-12-11 10:33
  - 顶部再上移两头像高度（topbar 负 margin -128）。
- 2025-12-11 10:34
  - 顶部微调：上移幅度減少至 -96px，避免頭像/「＋」被遮擋。
- 2025-12-11 10:34
  - 去除頂部負 margin，改用 sticky top + safe-area；移除 body 額外頂部留白，避免被白色安全區遮擋。
- 2025-12-11 10:35
  - 為各頁增加 56px padding-top，給黏性 topbar 預留空間，避免頂部與第一條聊天重疊。
- 2025-12-11 10:36
  - 聊天列表單獨下移（margin-top: 64px），不再動整個頁面 padding，避免與頂部重疊。
- 2025-12-11 10:37
  - 再下移聊天列表到 72px，頂部高度保持不動，避免重疊。
- 2025-12-11 11:05
  - 配置面板：模型列表新增可点击模型芯片，移除重复下拉图标，确保完整列表可见；切换服务商时表单回到对应默认值，避免 API Key/Base URL 泄漏到其他 provider。
  - 配置校验：provider 白名单同步 UI 选项，修复 makersuite 保存报「无效 provider」的问题。
  - Vertex 提示：前端明确标注 Vertex 需后端签名，刷新/测试直接提示使用 Makersuite 或代理，避免误用 Service Account。
- 2025-12-11 11:12
  - 修复配置保存报错：ConfigManager 新增 set() 用于更新内存缓存，配置面板保存后不再触发 `window.appBridge.config.set is not a function`。
- 2025-12-11 11:40
  - 世界書入口調整：移出頭像菜單，置於聊天室右上「≡」下拉（世界書 / 聊天設置）；保留快捷描述。
  - 世界書按會話隔離：AppBridge 支持 per-session world 映射（本地持久化），切換會話會同步當前世界書並更新指示器；世界書面板顯示當前會話 ID。
- 2025-12-11 12:00
  - 新增 Tauri KV 落盤：通用 save_kv/load_kv 命令；ChatStore/世界書/會話-世界書映射均落盤到 app_data 目錄，清空瀏覽器緩存也不丟失。
  - 安全處理配置：保存到文件時不寫入 API Key（需手動再次填入），BaseURL/模型等仍可持久；localStorage 也不再存 API Key。
- 2025-12-11 12:10
  - 世界書導入改為 ST 原生體驗：支持選擇 JSON 文件或貼上內容，名稱自動取 JSON.name/文件名，無需手填；去掉名稱輸入/手動切換按鈕。
- 2025-12-12 12:05
  - 長按氣泡菜單：AI 消息支持重新生成/刪除，使用消息前最近的用戶內容重新生成並替換；用戶消息支持編輯/刪除（編輯不觸發重生成）。
  - 消息存儲：ChatStore 增加消息 ID、更新/刪除接口，長按操作同步更新存儲與 UI，預載帶上 id 確保替換一致。
- 2025-12-12 14:40
  - 聊天室頂欄視覺微調：調整灰色頂欄高度、首條消息間距；避免鍵盤彈出導致頂欄被推出視口（使用 `100dvh` + 限制整頁滾動）。
  - 「＋」選單調整：改為 添加好友/创建群组/新建分组（後兩者暫占位）。
  - 好友列表（原會話列表）改造：添加好友會建立獨立聊天室並寫入联系人；刪除會同步移除联系人/聊天記錄並清除會話世界書映射，確保世界書按聊天室隔離。
- 2025-12-12 15:10
  - 修復配置落盤：統一 Tauri invoke 兼容（`core.invoke` / `invoke`），確保連線設定檔與 Keyring 使用 `save_kv/load_kv` 真正寫入 app_data，重啟/清緩存後仍可恢復。
  - 視覺微調：縮小聊天室頂欄灰色覆蓋（狀態欄區域保持透明）、增加首條消息上邊距，並加高輸入框避免過扁。
- 2025-12-12 15:25
  - 修復聊天室輸入框高度被 JS 覆寫：僅對 `<textarea>` 啟用 autosize，避免把 `<input>` 壓扁。
  - 頂欄安全區修正：限制 `safe-area-inset-top` 最大值，避免出現過大的白色安全區與過扁灰色頂欄。
- 2025-12-11 10:45 - 原版設計完整還原
  - **重大重構**：提取原版 `手机流式.html` 的完整 CSS 設計並清晰化架構。
  - 新增 `src/assets/css/qq-legacy.css`：原版 QQ 風格樣式系統（16+ 模塊，CSS 變量系統）。
  - 消息氣泡顏色還原為黃棕色系：`rgba(198, 164, 108, 0.85)`（原版配色）。
  - 完整還原消息界面佈局：頭像+用戶名橫向排列，聊天列表項顯示預覽+時間右上角。
  - 完整還原聊天室界面：頂部 `‹ 會話名 ≡`、底部 🎙 + 輸入框 + 發送（黑底白字）。
  - 完整還原聯系人界面：頂部一致佈局、搜索框 "搜索联系人..."、分組顯示（群組+未分組聯系人）。
  - 完整還原動態界面：頂部 "動態" + 🔔 + ⚙、動態卡片（頭像+內容+圖片+互動數據+評論）。
- 2025-12-11 10:53 - 聊天列表/聊天室邏輯分離修復
  - 修復聊天室元素溢出到消息界面問題：`.QQ_chat_page` 改為 `position: fixed` + 多重隱藏規則。
  - 進入聊天室時自動隱藏消息界面頂部和底部導航欄（完全匹配原版行為）。
  - 退出聊天室時恢復顯示頂部和底部導航欄。
  - 聊天列表和聊天室使用 `.hidden` 類互斥顯示，確保不會同時出現。
- 2025-12-11 11:20 - 狀態欄透明與頂部空白修復
  - 移除 `body` 的 `padding-top`，改為在 `.topbar` 使用 `env(safe-area-inset-top)`。
  - 頂欄緊貼手機狀態欄下方，無多餘空白。
  - 頂欄背景改為半透明：`rgba(255, 255, 255, 0.95)`，不完全遮擋狀態欄。
  - 添加 `<meta name="theme-color" content="transparent">`，Android 狀態欄透明顯示。
  - `body` 背景設為 `transparent`，可透視手機時間/電量圖標。
- 2025-12-11 11:26 - 聊天室完整還原（匹配原版截圖）
  - 聊天室顶部样式：半透明灰色 `rgba(230, 230, 230, 0.85)` + 毛玻璃效果。
  - 返回按鈕：`‹`（28px，左對齊）。
  - 菜單按鈕：`≡`（28px，右對齊）。
  - 會話名稱居中顯示。
  - 輸入區完整還原：🎙 麥克風 + 圓角輸入框（白色背景+灰邊框）+ "發送"（黑底白字 `#1a1a1a`）。
  - 底部輸入區背景：半透明灰色 `rgba(240, 240, 240, 0.95)` + 安全區適配。
- 2025-12-11 14:53 - UI 細節調整與輸入框優化
  - 修復下拉菜單位置：頭像/「+」按鈕菜單現在出現在按鈕下方（4px 間隙），不再遮擋按鈕本身。
  - 「+」按鈕菜單改為右對齊，避免被手機邊框切掉部分內容。
  - 聊天室頂部優化：減少頂部灰色區域高度（padding 從 8px 降至 4px/2px），改用 min-height: 36px，匹配原版緊湊設計。
  - 輸入框尺寸調整：輸入框高度增至 40px，語音按鈕 36px，發送按鈕增大（10px 20px），字體/圓角相應調整，匹配原版設計。
- 2025-12-11 15:06 - 聊天設置功能實現
  - 移除臨時的下拉菜單，改為完整的聊天設置彈窗（模態窗口），匹配原版設計。
  - 新增聊天設置彈窗：包含氣泡顏色、字體顏色、聊天壁紙設置，並提供實時預覽。
  - 實現隨機配色功能：一鍵生成隨機氣泡和字體顏色組合。
  - 設置持久化：將設置保存到 localStorage，按會話獨立存儲，切換會話自動應用對應設置。
  - 新增 ChatStore 方法：`getSessionSettings`、`setSessionSettings`、`clearMessages`、`switchSession`。
  - 添加 CSS 樣式到 `qq-legacy.css`：完整的彈窗樣式系統（遮罩層、標題欄、內容區、按鈕等）。
  - 聊天室菜單按鈕（≡）點擊打開設置彈窗，替代原下拉菜單。

- 2025-12-11 16:17 - API 串接功能实现（支持多个 LLM 服务商）
  - 新增 Google Gemini provider：完整支持 Google AI Studio 和 Vertex AI。
    - 实现消息格式转换（OpenAI 格式 → Gemini 格式）
    - 支持流式和非流式生成
    - 支持系统指令（systemInstruction）
    - 安全设置配置（GEMINI_SAFETY）
    - 模型列表获取
    - 健康检查
  - 新增 Deepseek provider：基于 OpenAI 兼容 API。
    - 继承 OpenAIProvider，设置默认 baseUrl 和模型
    - 支持所有 OpenAI 兼容功能（流式、非流式、模型列表等）
  - 更新 LLMClient：支持 5 种服务商（OpenAI、Gemini、Deepseek、Anthropic、Custom）。
  - 更新配置面板：
    - 服务商下拉菜单新增 Google Gemini 和 Deepseek 选项
    - 不同服务商自动切换默认配置（baseUrl、model、帮助文本）
    - 支持实时切换并更新占位符
  - 技术细节：
    - Gemini API 使用不同的消息格式（contents + systemInstruction）
    - 支持 Google AI Studio（API Key in URL）和 Vertex AI（Authorization header）
    - Deepseek 完全兼容 OpenAI API 格式
  - 文件修改：
    - 新增：`src/scripts/api/providers/gemini.js`（~300行）
    - 新增：`src/scripts/api/providers/deepseek.js`（~50行）
    - 修改：`src/scripts/api/client.js`（导入新 providers）
    - 修改：`src/scripts/ui/config-panel.js`（更新服务商选项和默认配置）

- 2025-12-11 18:00 - API 配置增强与安全存储（分离 Vertex AI 和 AI Studio）
  - **重大重构**：参考 SillyTavern 的安全存储方案，实现 API 配置增强。
  - 分离 Google Gemini 服务商为两个独立选项：
    - **Google AI Studio (Makersuite)**：使用 API Key 在 URL 参数中认证
    - **Google Vertex AI**：支持两种认证模式
      - 快速模式：使用 API Key（Authorization: Bearer）
      - 完整模式：使用 Service Account JSON（OAuth2 + Bearer token）
  - 实现 API Key 安全存储与掩码显示：
    - 保存后显示为 `••••••••••••••••`，保护敏感信息
    - 用户聚焦输入框时自动清空，便于修改
    - 原始 Key 存储在 `dataset.originalKey`，提交时使用实际值
    - Service Account JSON 同样支持掩码显示
  - 自动填写 Base URL 和模型：
    - 选择服务商时自动填写对应的 Base URL 和默认模型
    - 智能判断：如果当前值为空或为其他服务商的默认值，才自动填写
    - 避免误覆盖用户自定义配置
  - Vertex AI 专属配置字段（条件显示）：
    - **Project ID**：GCP 项目 ID（必填）
    - **Region**：5 个常用区域选项（us-central1、us-east1、us-west1、europe-west1、asia-southeast1）
    - **Service Account JSON**：完整模式认证（可选，支持掩码显示/隐藏切换）
  - 配置面板 UI 优化：
    - 动态字段可见性：选择 Vertex AI 时显示专属字段，其他服务商隐藏
    - 帮助文本自动更新：根据选择的服务商显示不同的提示
    - 添加显示/隐藏按钮：API Key 和 Service Account JSON 均支持切换显示
  - 技术实现细节：
    - Service Account JSON 认证需要后端支持（浏览器无法签署 RS256 JWT）
    - 当前实现会抛出友好错误，提示用户使用 AI Studio 或设置后端代理
    - Vertex AI Express 模式（API Key）可在前端直接使用
  - 文件修改：
    - 新增：`src/scripts/api/providers/makersuite.js`（~220行，AI Studio 专用）
    - 新增：`src/scripts/api/providers/vertexai.js`（~300行，Vertex AI 专用）
    - 修改：`src/scripts/api/client.js`（添加 makersuite 和 vertexai providers）
    - 重大修改：`src/scripts/ui/config-panel.js`（新增 Vertex AI 字段、掩码逻辑、自动填写、字段可见性控制）
  - 未来改进方向：
    - 可考虑实现后端代理以支持完整的 Service Account JSON 认证
    - 可考虑使用更安全的加密存储方案（如 Web Crypto API）
    - 可考虑添加配置导入/导出功能

- 2025-12-11 18:30 - 模型列表自动获取功能（仿 SillyTavern）
  - **新功能**：实现类似 SillyTavern 的模型列表自动获取和选择功能。
  - 将模型输入框改为**可输入的下拉选单**：
    - 使用 HTML5 `<datalist>` 元素实现
    - 用户可以手动输入模型 ID
    - 也可以从获取的模型列表中选择
    - 兼顾灵活性和便利性
  - 添加"⟳ 刷新列表"按钮：
    - 位于模型字段标签右侧
    - 点击后自动从 API 获取可用模型列表
    - 显示加载状态和进度提示
  - 智能验证：
    - 刷新前检查必填字段（Base URL、API Key）
    - Vertex AI 需要额外检查 Project ID
    - 缺少必填字段时给出友好提示
  - 实时反馈：
    - 获取中显示"正在从服务器获取可用模型列表..."
    - 成功后显示"已加载 N 个模型（可输入或从列表选择）"
    - 失败时显示错误信息并提示重试
    - 3-5 秒后自动恢复原始提示文本
  - 调用各 Provider 的 `listModels()` 方法：
    - OpenAI: 从 `/v1/models` 端点获取
    - Makersuite: 从 Google AI Studio API 获取
    - Vertex AI: 从 Vertex AI models 端点获取
    - Deepseek: 从 `/v1/models` 端点获取并过滤
    - Anthropic: 返回预定义的 Claude 模型列表
  - 用户体验优化：
    - 按钮加载状态（禁用+文字变化）
    - 彩色状态提示（蓝色加载、绿色成功、红色失败）
    - 自动恢复提示文本避免混淆
    - 保留用户手动输入能力
  - 文件修改：
    - 修改：`src/scripts/ui/config-panel.js`（新增 refreshModels 方法、UI 更新）

- 2025-12-11 18:45 - Vertex AI 优化与模型输入框改进
  - **Vertex AI Project ID 自动提取**：
    - 从 Service Account JSON 中自动提取 `project_id` 字段
    - 移除 Project ID 输入框（不再需要手动填写）
    - 简化配置流程，减少用户输入错误
    - 更新帮助文本："Project ID 会自动从 JSON 中提取"
  - **模型输入框视觉优化**：
    - 添加下拉箭头图标 (▼)，更符合下拉选单视觉习惯
    - 使用 `position: relative` 容器实现图标叠加
    - 保持完整的输入和选择功能
    - 右侧预留空间避免文字与图标重叠
  - **Vertex AI 配置验证优化**：
    - 刷新模型列表时检查 Service Account JSON（而非 Project ID）
    - 更准确的错误提示
  - 技术实现：
    - `VertexAIProvider` 构造函数中解析 Service Account JSON
    - 自动提取 `project_id` 字段并赋值
    - 保留 fallback 到 `config.vertexaiProjectId`（向后兼容）
  - 文件修改：
    - 修改：`src/scripts/api/providers/vertexai.js`（自动提取 Project ID）
    - 修改：`src/scripts/ui/config-panel.js`（移除 Project ID 字段、添加下拉箭头）

- 2025-12-14 18:30 - 連線設定檔重啟不可用修復 + 聊天室頂欄/輸入框樣式微調
  - **修復**：重啟後仍存在連線設定檔/Key，但因解密判斷錯誤導致 `apiKey` 變空、被判定「未配置」。
    - Keyring 記錄新增 `alg`（`aesgcm` / `b64`），避免把 base64 明文誤當 AES-GCM 密文解密。
    - 解密加入舊資料遷移：先試 AES-GCM，失敗才以「可打印 ASCII」判斷是否為 base64 明文並回填 `alg`。
    - `ensureStores()` 改為一次性初始化（不再依賴 `cryptoKey` 是否為 truthy），避免在無 WebCrypto 時反覆重建狀態。
    - master key 增加 localStorage fallback（僅供非 Tauri / dev 模式）。
  - **UI 微調**：聊天室頂欄與輸入框在部分 WebView 高度計算不穩定。
    - 移除頂欄對 `env()/clamp()` 的依賴，改為穩定的 padding/min-height。
    - 輸入框高度加大，消息列表預留底部空間同步調整。
  - 文件修改：
    - 修改：`src/scripts/storage/config.js`（Keyring alg/解密遷移/初始化修復）
    - 修改：`src/assets/css/qq-legacy.css`（聊天室頂欄/輸入框/間距調整）

- 2025-12-14 18:55 - 修復配置面板「已填但仍提示請填寫」的取值/校驗問題
  - **修復**：保存/测试时改为从面板自身 DOM 取值，并在移动端先 `blur()` 以提交输入法组合文本，避免读到空值。
  - **优化**：保存时不再依赖运行时解密到的 `apiKey` 才允许保存；若已通过 🔑 保存过 Key 也允许保存。
  - **提示**：若保存后仍无法取得可用 Key，将提示「请用 🔑 重新保存 Key」并不自动关闭弹窗。
  - 文件修改：
    - 修改：`src/scripts/ui/config-panel.js`

- 2025-12-14 20:10 - 新增「预设（Preset）」入口与 ST 风格 prompt 预设（sysprompt/context/instruct）
  - **新功能**：头像下拉选单新增「🎛 预设」，提供 SillyTavern 风格的预设管理面板（选择/编辑/新建/重命名/删除）。
  - **内置默认预设**：打包 SillyTavern 的默认 `sysprompt` / `context` / `instruct` 预设（用于离线与移动端）。
  - **接入 prompt 构建**：
    - 启用 `sysprompt` 时，将其 `content` 注入到 `context.story_string` 的 `{{system}}` 变量（并支持 `{{char}}/{{user}}` 替换）。
    - 启用 `context` 时，根据 `story_string_position`（IN_PROMPT/IN_CHAT/BEFORE_PROMPT）决定注入位置。
    - `sysprompt.post_history` 参照 ST 作为「历史后指令」以 user message 形式追加（jailbreak-like）。
  - 文件修改：
    - 新增：`src/assets/presets/st-defaults.json`
    - 新增：`src/scripts/storage/preset-store.js`
    - 新增：`src/scripts/ui/preset-panel.js`
    - 修改：`src/index.html`（settings menu 增加 preset）
    - 修改：`src/scripts/ui/app.js`（接入 preset 面板入口；生成时传入 user/char/history 上下文）
    - 修改：`src/scripts/ui/bridge.js`（prompt 构建接入 preset）

- 2025-12-14 20:40 - 预设面板可滚动 + 生成参数（OpenAI Preset）接入
  - **UI 修复**：预设面板改为全屏安全边距布局，内容区 `flex:1` 可滚动，避免在手机上显示不完整。
  - **生成参数**：新增「生成参数」tab，内置 SillyTavern 的 `openai/Default.json`（完整字段可编辑）。
  - **实际生效**：发送请求时会按 provider 映射常用生成参数：
    - OpenAI/Deepseek/Custom：`temperature/top_p/max_tokens/presence_penalty/frequency_penalty/seed/n`
    - Gemini/Makersuite/VertexAI：映射为 `generationConfig` 所需的 `temperature/top_p/top_k/maxTokens`
    - Anthropic：映射为 `maxTokens/temperature/top_p/top_k`
  - 文件修改：
    - 修改：`src/scripts/ui/preset-panel.js`（可滚动布局 + tab）
    - 修改：`src/scripts/storage/preset-store.js`（新增 `openai` 类型）
    - 修改：`src/assets/presets/st-defaults.json`（新增 `openai.Default`）
    - 修改：`src/scripts/ui/bridge.js`（生成参数注入到请求 options）

- 2025-12-14 20:45 - 预设面板 ST 化（纯文本/表单）+ 隐藏 marker 模块内容
  - **UI 修复**：预设面板改为 `top/left/right/bottom` 固定布局并扩大顶部间距，解决手机上方被状态栏覆盖与无法滚动的问题。
  - **ST 风格编辑**：不再用 JSON 编辑器，改为与 ST 类似的表单：
    - `sysprompt`：`content` / `post_history` 纯文本编辑
    - `context`：`story_string` 纯文本 + 注入位置/深度/角色 + 常用开关
    - `instruct`：序列/开关（当前仅保存，后续可扩展为完整 instruct mode）
    - `openai`：常用生成参数输入框 + 仅展示可编辑 prompts（隐藏 `chatHistory/worldInfo/...` 等 marker）
  - **prompt 构建**：当启用 `openai` 预设时，优先使用其可编辑 prompts：
    - `main` 作为系统提示词来源（覆盖 sysprompt）
    - `nsfw` / `enhanceDefinitions` 作为附加 system prompts
    - `jailbreak` 作为 post-history 指令（user message 形式追加）
  - 文件修改：
    - 修改：`src/scripts/ui/preset-panel.js`
    - 修改：`src/scripts/ui/bridge.js`

- 2025-12-14 21:00 - 修复预设面板被顶栏/底栏遮挡导致“被切掉”
  - 将 `#preset-overlay/#preset-panel` 的 `z-index` 提升到高于 `.topbar`/`.bottom-nav`，使弹窗覆盖全屏不再被遮挡。
  - 文件修改：
    - 修改：`src/scripts/ui/preset-panel.js`

- 2025-12-14 21:01 - 预设面板顶部空白优化 + 导入/导出预设设定档
  - **UI 优化**：将 safe-area 处理从面板内部 padding 改为 `top/left/right/bottom` 的 `calc(... + env(safe-area-inset-*))`，去掉顶部多余白色空白。
  - **导入/导出**：
    - 支持导出当前预设（按当前 tab）为 JSON 文件
    - 支持导出全部预设设定档（包含所有类型、启用状态、当前选中项）
    - 支持导入单个预设 JSON（自动识别类型：sysprompt/context/instruct/openai）
    - 支持导入整套预设设定档（可选覆盖或合并）
  - **持久化**：导入后立即落盘，重启 app 自动加载上次保存的预设配置。
  - 文件修改：
    - 修改：`src/scripts/ui/preset-panel.js`
    - 修改：`src/scripts/storage/preset-store.js`

- 2025-12-14 21:05 - OpenAI 预设：区块式 Prompt Manager（拖拽排序/自定义区块）并按顺序构建提示词
  - **ST 风格区块**：在「生成参数」tab 以 `prompt_order` 渲染所有区块（含 marker），支持拖拽调整顺序、启用/禁用、并可新增自定义区块。
  - **导入可见**：导入带 `prompts/prompt_order` 的 ST OpenAI 预设后，会直接显示对应区块。
  - **构建方式**：生成时若启用 OpenAI 预设且存在 `prompt_order`，则按区块顺序拼接 messages，并在 `chatHistory` marker 位置插入历史消息。
  - **当前差异**：未实现 ST 的 token 预算裁剪/对话示例注入/系统消息压缩等高级逻辑（后续可逐步补齐）。
  - 文件修改：
    - 修改：`src/scripts/ui/preset-panel.js`
    - 修改：`src/scripts/ui/bridge.js`

- 2025-12-14 21:18 - 预设面板：新增「自定义」tab + 区块默认折叠 + 防止保存时清空区块
  - **自定义 Tab**：新增「自定义」tab 专门放 ST 的 Prompt Manager 区块（导入/新增的可编辑区块都在这里），「生成参数」tab 只保留常用生成参数。
  - **默认折叠**：区块默认折叠，点击区块头部展开/收起（marker 区块仅显示提示，不显示内容编辑）。
  - **导入体验**：导入 OpenAI 预设后自动切到「自定义」tab；从「自定义」导出会正确导出 OpenAI 预设。
  - **关键修复**：修复在「生成参数」tab 点击保存会把 `prompt_order` 清空导致区块“消失”的问题。
  - **显示修复**：弹窗高度改用 `100dvh`（带 `100vh` fallback），避免手机上方/下方被切掉。
  - 文件修改：
    - 修改：`src/scripts/ui/preset-panel.js`

- 2025-12-14 21:28 - 预设区块禁用灰化 + 预设绑定 API 连接配置（profile）
  - **区块灰化**：Prompt blocks 未启用时整体呈灰色，方便区分启用/禁用状态。
  - **绑定连接配置**：在「生成参数/自定义」保存预设时，会记录当前 API 连接 profile id；切换预设时自动切换到绑定的 profile 并更新 LLM client。
  - **启动加载**：App 初始化时若启用该预设且其绑定了 profile，会优先加载绑定的连接配置，避免重启后提示“未配置”。
  - 文件修改：
    - 修改：`src/scripts/ui/preset-panel.js`
    - 修改：`src/scripts/ui/bridge.js`

- 2025-12-14 21:50 - 正规表达式（正则）三种作用域：全局 / 局部（绑定预设/世界书）/ 聊天室
  - **入口**：
    - 点击头像菜单新增「正规表达式」：管理全局/局部正则
    - 聊天室右上角「三」菜单新增「正规表达式」：管理该聊天室独立正则
  - **作用域**：
    - 全局正则：始终生效
    - 局部正则：绑定到特定预设或世界书，切换到对应对象时自动生效
    - 聊天室正则：仅在当前会话生效
  - **生效时机**：输入（发送前）/输出（显示前）/两者可选；输入在 `AppBridge.generate()` 构建 messages 前处理，输出在非流式返回前与流式保存历史时处理（UI 流式结束时会同步刷新为处理后的结果）。
  - 文件修改：
    - 新增：`src/scripts/storage/regex-store.js`
    - 新增：`src/scripts/ui/regex-panel.js`
    - 新增：`src/scripts/ui/regex-session-panel.js`
    - 修改：`src/index.html`
    - 修改：`src/scripts/ui/app.js`
    - 修改：`src/scripts/ui/bridge.js`

- 2025-12-14 22:11 - 世界书全局作用域入口 + 导入时自动带入绑定正则
  - **全局世界书**：头像菜单新增「世界书」，打开的世界书为全局通用作用域（不影响聊天室内单独世界书管理）。
  - **Prompt 构建**：发送时会同时注入「全局世界书」与「当前会话世界书」（若两者都启用）。
  - **导入联动**：导入预设/世界书 JSON 若包含 `boundRegexSets`，会自动导入并绑定对应对象，同时启用。
  - 文件修改：
    - 修改：`src/index.html`
    - 修改：`src/scripts/ui/app.js`
    - 修改：`src/scripts/ui/bridge.js`
    - 修改：`src/scripts/ui/world-panel.js`
    - 修改：`src/scripts/ui/preset-panel.js`

- 2025-12-14 22:11 - 预设导入：兼容 ST 的 RegexBinding 自动导入
  - **问题修复**：部分 ST 预设将绑定正则存放在 `RegexBinding.regexes`（可能嵌在 `SPreset` 或塞在 `prompts[n].content` 的 JSON 字符串里），之前未识别导致导入后正则未同步。
  - **现在行为**：导入预设时若检测到 `RegexBinding.regexes`，会自动转换为局部正则集合并绑定到该预设，且默认启用（单条脚本遵循其 `disabled` 状态）。
  - 文件修改：
    - 修改：`src/scripts/ui/preset-panel.js`
    - 修改：`src/scripts/storage/regex-store.js`
    - 修改：`src/scripts/ui/regex-panel.js`
    - 修改：`src/scripts/ui/regex-session-panel.js`

- 2025-12-14 22:21 - 正则导入体验优化：规则默认折叠 + 导入确认 + 去重
  - **折叠**：全局/局部/聊天室正则规则与预设区块一致，默认折叠，点击标题展开编辑。
  - **导入确认**：导入预设/世界书若检测到绑定正则，会弹窗询问是否一并导入；取消则仅导入预设/世界书。
  - **去重**：导入时会跳过与现有正则“完全相同”的规则（按 `when/pattern/flags/replacement` 判定），避免重复导入。
  - 文件修改：
    - 修改：`src/scripts/ui/regex-panel.js`
    - 修改：`src/scripts/ui/regex-session-panel.js`
    - 修改：`src/scripts/ui/preset-panel.js`
    - 修改：`src/scripts/ui/world-panel.js`
    - 修改：`src/scripts/storage/regex-store.js`

- 2025-12-14 22:55 - UI 文案 + 预设生成参数补全
  - **头像菜单**：将「设定」改为「API设定」。
  - **生成参数**：新增最大上下文长度（拉条）与最大输出 token（`openai_max_context/openai_max_tokens`）。
  - 文件修改：
    - 修改：`src/index.html`
    - 修改：`src/scripts/ui/preset-panel.js`

- 2025-12-14 23:17 - 聊天体验：时间戳修复 + 好友头像/设置入口
  - **时间戳**：修复使用 `toLocaleTimeString().slice(0,5)` 导致「下午 7:4」被截断的问题，统一改为 `hour/minute` 格式化。
  - **添加好友头像**：添加好友时可选择头像（本地图片），保存到联系人资料并用于聊天列表/聊天头像。
  - **好友设置**：点击聊天室标题弹出下拉菜单，新增「设置」打开好友设置面板，可修改头像与显示名称（不改会话 ID）。
  - 文件修改：
    - 修改：`src/index.html`
    - 新增：`src/scripts/ui/contact-settings-panel.js`
    - 修改：`src/scripts/ui/app.js`
    - 修改：`src/scripts/ui/session-panel.js`
    - 修改：`src/scripts/ui/chat/chat-ui.js`

- 2025-12-14 23:36 - 头像存储稳定性 + GIF 支持 + 流式 UI 修复 + 世界书绑定正则生效
  - **头像压缩**：添加好友/好友设置选择头像时，非 GIF 图片会自动压缩（缩放+质量控制）后保存，减少 `exceeds quota` 发生概率。
  - **GIF 头像**：GIF 头像不做 canvas 转换，保留动图效果（依赖 `save_kv` 持久化，localStorage 仅尽力写入）。
  - **联系人存储健壮性**：联系人持久化改为优先 `save_kv`，localStorage 写入失败（配额不足）时不会阻断保存。
  - **正则作用域**：世界书绑定的局部正则在「全局世界书」启用时也能正确生效（regex ctx 增加 `worldIds`）。
  - **流式多余点修复**：流式发送不再同时渲染「打字指示器 + 空白流式气泡」，改为单一流式气泡内显示跳动动画，避免多出一个小点。
  - 文件修改：
    - 新增：`src/scripts/utils/image.js`
    - 修改：`src/scripts/storage/contacts-store.js`
    - 修改：`src/scripts/ui/session-panel.js`
    - 修改：`src/scripts/ui/contact-settings-panel.js`
    - 修改：`src/scripts/ui/bridge.js`
    - 修改：`src/scripts/storage/regex-store.js`
    - 修改：`src/scripts/ui/chat/chat-ui.js`
    - 修改：`src/scripts/ui/app.js`

- 2025-12-15 00:16 - 正则系统对齐 ST：预设绑定生效 + 完整选项 + 暂时性语义
  - **预设/世界书绑定正则生效**：切换到绑定对象时自动启用，并按 ST 逻辑作用于 AI 气泡显示与 prompt 构建。
  - **ST 完整字段**：支持 Affects(placement)、Disabled、Run On Edit、Min/Max Depth、Find Regex 宏替换（不替换/raw/escaped）、Trim Out、Ephemerality（仅影响显示/仅影响 prompt）。
  - **暂时性语义**：不勾选暂时性时视为“直接改存档内容”（保存到 `raw`）；勾选“仅影响显示”时只改 `content` 显示；勾选“仅影响 prompt”只在构建 prompt 时生效。
  - **自动重渲染**：修改正则/切换预设/切换世界书后，当前聊天室会基于 `raw` 自动重算显示文本；编辑用户消息时尊重 Run On Edit。
  - 文件修改：
    - 修改：`src/scripts/storage/regex-store.js`
    - 修改：`src/scripts/ui/bridge.js`
    - 修改：`src/scripts/ui/app.js`
    - 修改：`src/scripts/ui/preset-panel.js`
    - 修改：`src/scripts/ui/world-panel.js`
    - 修改：`src/scripts/ui/regex-panel.js`
    - 修改：`src/scripts/ui/regex-session-panel.js`

- 2025-12-15 00:22 - 修复移动端无法点击：避免 worldinfo-changed 事件递归
  - **问题**：worldinfo-changed 事件触发重渲染时再次调用 `setActiveSession()`，导致事件递归触发，页面卡死按钮无法点击。
  - **修复**：重渲染当前会话不再调用 `setActiveSession()`，仅重算显示并刷新列表。
  - 文件修改：
    - 修改：`src/scripts/ui/app.js`

- 2025-12-15 00:31 - 修复 Android 真机白屏/不可点击：regex-store.js 正则字面量语法错误
  - **问题**：`src/scripts/storage/regex-store.js` 中把 ST 的 `/(\/?)(.+)\1([a-z]*)/i` 误写成包含未转义 `/` 的形式，Android WebView 直接抛 `Invalid regular expression`，导致脚本中断、UI 按钮无法点击。
  - **修复**：对齐 ST 原实现（regexFromString + flags 校验 + 宏替换正则），并修正 `replace` 回调绑定写法，避免语法错误。
  - 文件修改：
    - 修改：`src/scripts/storage/regex-store.js`

- 2025-12-15 00:41 - 聊天气泡支持「酒馆助手」风格代码块渲染：HTML iframe 预览
  - **代码块渲染**：聊天文本支持解析 fenced code block（```lang），以安全方式渲染为代码卡片（可复制）。
  - **HTML 呈现**：当代码块为 HTML（或内容包含 `<body>...</body>`）时，提供沙盒 iframe 预览并自动自适应高度；若整段消息本身就是 HTML 文档也会自动按 HTML 代码块处理。
  - **流式兼容**：流式生成过程中保持纯文本更新，结束后再进行代码块/iframe 渲染，避免卡顿。
  - 文件修改：
    - 新增：`src/scripts/ui/chat/rich-text-renderer.js`
    - 修改：`src/scripts/ui/chat/chat-ui.js`

- 2025-12-15 00:49 - HTML 片段也可渲染（不再仅限 <body> 文档）
  - **问题**：部分正则会把 `<thinking>` 替换为 `<style>...` + `<details>/<div>` 的 HTML 片段（不包含 `<body>`），之前因仅识别 `<body>` 导致无法渲染。
  - **修复**：当整段消息明显是 HTML 片段（以 `<` 开头且含 style/details/div 等并有闭合标签）时，自动按 `html` 代码块处理并打开 iframe 预览。
  - 文件修改：
    - 修改：`src/scripts/ui/chat/rich-text-renderer.js`

- 2025-12-15 00:55 - iframe 预览自适配手机宽度（更美观，不易溢出）
  - **基础样式**：在 iframe 内注入 `max-width:100%`、图片/表格响应式、默认 padding 等样式，减少超出手机屏幕的问题。
  - **自动适配**：检测内容横向溢出时自动缩放（最低 0.78），仍溢出则允许横向滚动，尽量兼顾可读性与不超宽。
  - 文件修改：
    - 修改：`src/scripts/ui/chat/rich-text-renderer.js`

- 2025-12-15 01:02 - iframe 手机排版进一步贴近 ST：不再出现超长横向滚动 + 隐藏源码区块
  - **横向滚动**：改为移动端优先，强制避免长横向滚动；溢出时自动缩放到更低阈值（最低 0.55）并保持 `overflow-x:hidden`。
  - **隐藏源码**：HTML 预览默认只显示渲染结果，不再显示黑底源码；需要时可点「代码」切换查看。
  - 文件修改：
    - 修改：`src/scripts/ui/chat/rich-text-renderer.js`

- 2025-12-15 01:20 - 代码渲染区长按可呼出菜单：移除内嵌按钮，代码/复制移入长按菜单
  - **长按可点到 iframe**：HTML iframe 预览内的按压事件会转发到外层聊天 UI，长按渲染区域也能弹出消息菜单（不必再点气泡边缘）。
  - **移除内嵌工具条**：去掉代码块内的「预览/代码/复制」工具条与黑底源码重复显示；HTML 预览默认只显示渲染结果。
  - **菜单新增动作**：长按代码块时菜单增加「代码」「复制」，其中「代码」会打开全屏代码查看器（自动换行，避免超长横向滚动）。
  - 文件修改：
    - 修改：`src/scripts/ui/chat/rich-text-renderer.js`
    - 修改：`src/scripts/ui/chat/chat-ui.js`

- 2025-12-15 08:41 - 长按更稳定 + 代码编辑保存后即时套用正则并重渲染
  - **长按稳定性**：聊天气泡与 iframe 渲染区域禁用系统文字选取/长按菜单，并增加 contextmenu 转发与滑动取消阈值，减少“长按只选中文字”的情况。
  - **菜单消失**：点击 iframe 内区域也会像点击外部一样关闭菜单（通过 iframe down 事件转发实现）。
  - **原回复编辑**：长按代码块点「代码」会打开“原回复”编辑器（未套用正则），保存后会对内容重新套用正则并立即更新气泡/iframe 渲染。
  - 文件修改：
    - 修改：`src/assets/css/qq-legacy.css`
    - 修改：`src/scripts/ui/chat/rich-text-renderer.js`
    - 修改：`src/scripts/ui/chat/chat-ui.js`
    - 修改：`src/scripts/ui/app.js`

- 2025-12-15 09:13 - 切换到“对话模式”准备：停用创意写作输出链路 + 增加对话提示词入口与注入
  - **停用创意写作链路（保留注释）**：将 AI 输出的 display 正则替换与富文本/iframe 渲染逻辑注释掉并标记“创意写作模式”，当前改为纯文本显示，方便后续按 <content>/msg_start 协议解析分流。
  - **预设新增对话提示词**：在预设面板增加「对话提示词」tab（保存于 sysprompt 预设），可粘贴 `手机流式.html` 的规则提示词并独立启用。
  - **prompt 注入位置/深度**：对话提示词支持 ST 风格的注入位置（BEFORE_PROMPT / IN_PROMPT / IN_CHAT / NONE）与 IN_CHAT 深度/角色配置；构建 prompt 时按相同语义注入到消息列表中。
  - 文件修改：
    - 修改：`src/scripts/ui/app.js`
    - 修改：`src/scripts/ui/chat/chat-ui.js`
    - 修改：`src/scripts/ui/preset-panel.js`
    - 修改：`src/scripts/ui/bridge.js`

- 2025-12-15 09:31 - 搬运“私聊对话提示词”：默认启用并自动注入聊天室 prompt（移除群聊/动态/主动消息）
  - **默认私聊协议提示词**：把 `手机流式.html` 中私聊相关的输出协议/节奏约束整理为“对话提示词”，仅保留私聊（去掉群聊、动态、评论、主动发起等内容），并要求输出 `msg_start...msg_end` + `<{{user}}和{{char}}的私聊>` 格式。
  - **自动启用**：对话提示词在 sysprompt 预设中默认 `启用`，聊天发送时自动注入到 prompt（用户可在预设面板的「对话提示词」tab 中修改/关闭）。
  - **变量对齐**：对话宏 `{{user}}` 默认使用“我”，与当前聊天 UI 一致（后续可扩展为用户昵称）。
  - 文件修改：
    - 修改：`src/scripts/storage/preset-store.js`
    - 修改：`src/scripts/ui/app.js`

- 2025-12-15 09:58 - 实作对话模式“流式解析”雏形：只捕获完整有效标签并分条输出到聊天室
  - **简化解析器**：新增流式解析器，仅忽略 `<thinking>`，聚焦 `<content>`，并在捕获到完整的私聊标签 `<{{user}}和{{char}}的私聊>...</...>` 后再输出（不逐字显示原文）。
  - **分条气泡输出**：私聊标签内部按行解析（优先 `-` 开头），每一行作为一条独立气泡；支持 `[img-]`/`[yy-]`/`[music-]` 等特殊消息格式。
  - **流式体验**：在捕获到第一个完整有效标签前只显示“等待回复”动画；每次输出后继续显示等待动画直到流结束。
  - **提示词同步**：默认私聊对话提示词更新为 `<content> + 私聊标签 + - 行` 协议，并对旧版 `msg_start` 协议做自动迁移（仅当检测到旧规则且未包含 `<content>`）。
  - 文件修改：
    - 新增：`src/scripts/ui/chat/dialogue-stream-parser.js`
    - 修改：`src/scripts/ui/app.js`
    - 修改：`src/scripts/storage/preset-store.js`

- 2025-12-15 10:08 - 修复对话模式私聊分流误建同名会话：优先路由到当前会话/已存在联系人
  - **问题**：解析到 `<{{user}}和{{char}}的私聊>` 后把 `{{char}}` 当作会话 id，导致在当前会话 id 与显示名不同（或含空格差异）时误创建同名联系人/会话，并把回复写入新会话。
  - **修复**：对私聊标签的目标会话进行解析：若标签指向当前聊天对象（按当前会话的联系人名/id 比对）则写回当前会话；否则优先匹配已存在联系人（按 name 精确匹配）并复用其 id，避免重复创建。
  - 文件修改：
    - 修改：`src/scripts/ui/app.js`

- 2025-12-15 10:38 - 对话模式更严格 + 动态（Moments）基础实现
  - **更严格分流**：若私聊标签无法匹配“当前会话/已存在联系人”，不再自动新建同名会话，视为回覆格式错误并丢弃。
  - **动态存储/渲染**：新增动态存储 `MomentsStore` 并把 `moments-page` 的列表改为真实渲染（支持查看详情与本地添加评论）。
  - **动态解析**：对话流式解析器新增对 `moment_start...moment_end` 与 `moment_reply_start...moment_reply_end` 的识别（在 `<content>` 内），解析后写入动态列表；流式/非流式均可处理。
  - 文件修改：
    - 修改：`src/scripts/ui/app.js`
    - 修改：`src/scripts/ui/chat/dialogue-stream-parser.js`
    - 新增：`src/scripts/storage/moments-store.js`
    - 新增：`src/scripts/ui/moments-panel.js`
    - 修改：`src/index.html`

- 2025-12-15 10:44 - 搬运动态提示词并拆分提示词页签：私聊提示词 + 动态提示词（注入位置/深度可配）
  - **页签拆分**：将原“对话提示词”页签更名为「私聊提示词」，新增「动态提示词」页签。
  - **动态提示词搬运**：把 `手机流式.html` 的 QQ空间/动态格式介绍迁移为默认动态提示词，并适配到 `<content>` 内输出（moment_start/moment_reply_*）。
  - **注入语义对齐**：动态提示词与私聊提示词一样，支持 ST 风格注入位置（BEFORE_PROMPT/IN_PROMPT/IN_CHAT/NONE）与 IN_CHAT 深度/角色；默认深度为 0（与原文件“深度=0”一致），默认不启用，避免影响纯私聊聊天。
  - 文件修改：
    - 修改：`src/scripts/ui/preset-panel.js`
    - 修改：`src/scripts/storage/preset-store.js`
    - 修改：`src/scripts/ui/bridge.js`

- 2025-12-15 10:50 - 聊天提示词改为同一页签区块：私聊/动态共用 tab（默认折叠）+ 动态评论规则注释
  - **UI 调整**：将「私聊提示词」「动态提示词」合并为一个 tab「聊天提示词」，内部以两个区块呈现（样式对齐“自定义”区块，默认折叠，点击展开；禁用时整体灰化）。
  - **动态提示词调整**：将动态的“评论/评论回复”相关规则注释（后续再做评论系统），并对旧默认规则做自动迁移（不覆盖用户自定义）。
  - 文件修改：
    - 修改：`src/scripts/ui/preset-panel.js`
    - 修改：`src/scripts/storage/preset-store.js`

- 2025-12-15 11:08 - 动态提示词补齐动态发布决策（momentCreationTask）
  - **搬运 momentCreationTask**：将 `手机流式.html` 的 `momentCreationTask`（动态发布决策：时机/概率/性格/输出规则）加入默认动态提示词中，用于让模型决定何时输出 `moment_start...moment_end`。
  - **默认规则迁移**：若用户仍使用旧版默认动态提示词（不含动态发布决策段落），自动迁移为新版（不覆盖用户自定义内容）。
  - 文件修改：
    - 修改：`src/scripts/storage/preset-store.js`

- 2025-12-15 11:24 - 世界书管理支持“新增”世界书并按作用域自动绑定启用
  - **新增按钮**：世界书管理面板添加「新增」，可输入名称后创建空白世界书并立刻打开编辑器。
  - **会话/全局区分**：从聊天室右上角「三」打开的世界书管理，新增后自动绑定并启用到当前会话；从头像菜单打开的世界书管理（全局），新增后自动全局启用。
  - 文件修改：
    - 修改：`src/scripts/ui/world-panel.js`

- 2025-12-15 11:39 - 动态头像/评论交互对齐手机流式：按联系人头像渲染 + 评论折叠 + 三点菜单
  - **头像来源修复**：动态作者头像优先从联系人资料匹配（按 name/id 精确与去空格小写匹配），并支持「我/用户」回退到用户头像。
  - **评论折叠**：评论超过 8 条时默认折叠，仅显示最新 8 条；支持「展开查看更多评论 / 收起评论」。
  - **三点菜单**：动态右上角「⋯」弹出下拉菜单（删除/取消），交互与旧版 `手机流式.html` 接近。
  - 文件修改：
    - 修改：`src/scripts/ui/moments-panel.js`
    - 修改：`src/scripts/storage/moments-store.js`
    - 修改：`src/scripts/ui/app.js`
    - 修改：`src/assets/css/main.css`

- 2025-12-15 11:45 - 动态头像再修复：落盘 authorId 并渲染优先使用绑定联系人头像
  - **authorId 绑定**：动态写入 store 时根据作者名解析匹配联系人 id（支持模糊/子串），并落盘为 `authorId`，避免名称变更导致匹配失败。
  - **渲染优先级**：动态渲染时优先用 `authorId -> 联系人.avatar`，回退到按作者名匹配与默认头像。
  - 文件修改：
    - 修改：`src/scripts/ui/app.js`
    - 修改：`src/scripts/storage/moments-store.js`
    - 修改：`src/scripts/ui/moments-panel.js`

- 2025-12-15 11:59 - 动态头像三修：落盘 authorAvatar 快照 + 更强名称归一 + 自动回填旧动态
  - **authorAvatar 快照**：动态入库时会把匹配到的头像写入 `authorAvatar`，渲染优先使用该快照，避免任何名称匹配偏差。
  - **归一规则增强**：作者名归一仅保留字母/数字/CJK，过滤 emoji/符号，提升与联系人名称匹配成功率。
  - **旧动态回填**：渲染时若检测到旧动态缺少 `authorAvatar`，会按当前联系人信息回填一次并持久化。
  - 文件修改：
    - 修改：`src/scripts/ui/app.js`
    - 修改：`src/scripts/storage/moments-store.js`
    - 修改：`src/scripts/ui/moments-panel.js`

- 2025-12-15 12:10 - 对齐手机流式“发言人”头像绑定：动态作者占位符自动归一为当前聊天对象
  - **作者名归一**：当动态作者为“发言人/角色/角色名/作者”等占位符时，写入动态时自动替换为当前聊天对象名，避免后续头像匹配失败。
  - 文件修改：
    - 修改：`src/scripts/ui/app.js`

- 2025-12-15 12:53 - 聊天室加入“原始回复”查看：显示最新一轮完整模型输出
  - **入口**：聊天室右上角「三」菜单新增「🧾 原始回复」。
  - **存储**：每次生成后按会话保存最新一轮原始输出（流式/非流式均覆盖），并做长度上限截断以降低配额风险。
  - **面板**：新弹窗显示完整原始文本（可滚动），支持一键复制。
  - **稳定性**：ChatStore 写入 localStorage 增加 try/catch，避免配额异常导致前端崩溃/按钮失灵。
  - 文件修改：
    - 修改：`src/index.html`
    - 修改：`src/scripts/ui/app.js`
    - 修改：`src/scripts/storage/chat-store.js`

- 2025-12-15 13:02 - 动态头像兜底对齐“当前会话人格”：记录 originSessionId 并用于头像回退
  - **原因**：动态作者名可能与联系人记录不一致（别名/翻译/符号差异），导致仅靠作者名匹配失败而回退默认头像。
  - **修复**：动态写入时记录 `originSessionId`（本轮生成所在聊天室），渲染时若作者未匹配到联系人头像则回退使用 originSessionId 的联系人头像。
  - **旧数据回填**：渲染时若旧动态缺少 `originSessionId` 且已有 `authorId`，自动回填为 `authorId`。
  - 文件修改：
    - 修改：`src/scripts/ui/app.js`
    - 修改：`src/scripts/storage/moments-store.js`
    - 修改：`src/scripts/ui/moments-panel.js`

- 2025-12-15 13:29 - 修复动态重启丢失：加强磁盘持久化并避免写入巨大头像数据
  - **磁盘写入队列**：`save_kv` 改为串行队列写入并提供 `flush()`，避免短时间多次写入丢失/覆盖。
  - **生成后强制落盘**：在对话模式解析到动态后，生成结束会 `await momentsStore.flush()`，确保关闭 App 前已写入磁盘。
  - **减少体积**：动态条目不再持久化 `data:` 头像（base64/gif），避免 moments JSON 过大导致保存失败；渲染时继续从联系人头像获取。
  - 文件修改：
    - 修改：`src/scripts/storage/moments-store.js`
    - 修改：`src/scripts/ui/app.js`

- 2025-12-15 13:36 - 修复动态“评论”导致内容消失：MomentsStore.upsert 支持局部更新不覆盖原字段
  - **问题**：动态列表渲染时会做回填（originSessionId/authorAvatar 等），使用 `upsert({id,...})` 传入局部字段；旧实现会把未传字段默认写成空字符串，导致动态内容/作者等被覆盖为空。
  - **修复**：`upsert` 改为 patch-safe：仅当字段被显式提供时才覆盖，否则保留现有值；并在加载/写入前统一剔除 `data:` 头像以降低存储体积。
  - 文件修改：
    - 修改：`src/scripts/storage/moments-store.js`

- 2025-12-15 15:29 - 动态评论功能启用：提示词取消注释 + <br> 正确换行 + 用户评论触发 AI 回复
  - **提示词**：动态提示词恢复“评论行/评论回复”规则，支持 `moment_reply_start/moment_reply_end`。
  - **渲染**：动态正文与评论内容把 `<br>` 渲染为换行（仅允许 `<br>`，其余仍转义防注入）。
  - **用户评论 -> AI 回复**：在动态点「评论」发送后，会调用模型生成 `moment_reply_*`（发布者必须回复+至少1名其他联系人参与），并可选追加私聊块；解析后写入动态/聊天室存储并落盘。
  - **互动数模拟**：评论触发时会对浏览/点赞做小幅随机增量，模拟社交软件变化。
  - 文件修改：
    - 修改：`src/scripts/storage/preset-store.js`
    - 修改：`src/scripts/ui/moments-panel.js`
    - 修改：`src/scripts/ui/app.js`

- 2025-12-15 15:50 - 动态评论长按删除 + 浏览/点赞按联系人数量 N 缩放
  - **长按删除评论**：动态评论支持长按弹出菜单，删除单条评论（不影响其他评论）。
  - **初始数值约束**：动态发布时强制保证 `浏览 < N*10`、`点赞 < N*2`（N=联系人数量，忽略群聊），超出则自动归一到范围内。
  - **评论后增长**：每次评论/回复后按 N 规模随机增加浏览与点赞（浏览增长明显快于点赞），模拟真实社交软件。
  - 文件修改：
    - 修改：`src/scripts/storage/moments-store.js`
    - 修改：`src/scripts/ui/moments-panel.js`
    - 修改：`src/scripts/ui/app.js`

- 2025-12-15 20:03 - 修复私聊标签含空格导致不显示 + DeepSeek Failed to fetch
  - **私聊解析**：对话解析器不再按空格截断 tagName，支持如 `<我和Lara croft的私聊>` 这类包含空格的标签；并把消息中的 `<br>` 转为换行。
  - **DeepSeek / 自定义 URL**：放宽 CSP `connect-src` 支持任意 `https:`/`http:` 域名请求，解决 WebView fetch 被 CSP 拦截导致的 `Failed to fetch`。
  - 文件修改：
    - 修改：`src/scripts/ui/chat/dialogue-stream-parser.js`
    - 修改：`src-tauri/tauri.conf.json`

- 2025-12-15 20:21 - 修复 DeepSeek 仍 Failed to fetch：改用原生 HTTP 绕过 WebView CORS
  - **根因**：DeepSeek / OpenAI-compatible 多数端点不提供浏览器 CORS 头，WebView `fetch` 会直接失败；仅放宽 CSP 不足以解决。
  - **原生请求**：新增 Tauri 命令 `http_request`（Rust `reqwest`），前端在 Tauri 环境下优先通过 `invoke` 走原生网络栈。
  - **适配范围**：`OpenAIProvider`（含 DeepSeek / custom）发送与拉取模型列表都走原生 HTTP；非 Tauri 环境保持使用 `fetch`。
  - 文件修改：
    - 修改：`src-tauri/Cargo.toml`
    - 修改：`src-tauri/src/commands.rs`
    - 修改：`src-tauri/src/lib.rs`
    - 修改：`src/scripts/api/providers/openai.js`
    - 修改：`src/scripts/api/providers/deepseek.js`

- 2025-12-15 22:03 - 进一步修复仍走 fetch 导致 CORS：原生请求优先级提升 + custom provider 同步
  - **问题**：部分环境下 `__TAURI_INVOKE__` 探测不稳定，导致 OpenAI/DeepSeek 仍走 `fetch` 触发 CORS。
  - **修复**：统一用 `globalThis` 探测，并在 `request()` 内“先尝试 invoke，再回退 fetch”，避免误判。
  - **覆盖 custom**：`CustomProvider`（OpenAI-compatible 自建地址）也切换到同一套原生 HTTP 逻辑。
  - 文件修改：
    - 修改：`src/scripts/api/providers/openai.js`
    - 修改：`src/scripts/api/providers/custom.js`

- 2025-12-15 22:05 - Tauri 环境禁用 CORS 回退：invoke 失败直接报原生错误
  - **问题**：在 Tauri WebView 中，`fetch` 必然触发 CORS（DeepSeek 等），回退会掩盖真实原因。
  - **修复**：检测到 `tauri.localhost` / `__TAURI__` 时，`http_request` 调用失败将直接抛出错误（不再回退到 `fetch`），便于定位是“命令未注册/后端异常/权限问题”。
  - 文件修改：
    - 修改：`src/scripts/api/providers/openai.js`
    - 修改：`src/scripts/api/providers/custom.js`

- 2025-12-15 22:22 - 修复 DeepSeek 400 / Gemini 不显示：请求头与对话解析更健壮
  - **DeepSeek 400**：流式请求添加 `Accept: text/event-stream`；并对 OpenAI-compatible 参数做清洗（DeepSeek 不发送 `seed/n` 等易触发 400 的字段）；错误信息附带服务端返回细节。
  - **Gemini 不显示**：对话解析器匹配闭合标签改为容错（允许闭合标签 `</tag >` 等空白差异）；流式结束未解析到有效标签会提示“已丢弃，可在原始回复查看”。
  - **日志增强**：发送失败会额外打印 `{status, response}` 方便定位。
  - 文件修改：
    - 修改：`src/scripts/api/providers/openai.js`
    - 修改：`src/scripts/api/providers/custom.js`
    - 修改：`src/scripts/ui/chat/dialogue-stream-parser.js`
    - 修改：`src/scripts/ui/app.js`

- 2025-12-15 22:46 - 预设保存与 Prompt 验证：跨 tab 保存 + 本次 Prompt 预览
  - **跨 tab 保存**：预设面板切换 tab/预设时自动缓存草稿，点击「保存」会把所有 tab 的改动一并落盘，避免“只保存当前 tab 导致其他 tab 改动丢失”。
  - **Prompt 预览**：聊天室右上角「三」新增 `🧩 本次 Prompt`，可查看本次实际发送给模型的 messages（纯文本，含 role 分段），用于确认“格式要求/聊天协议提示词是否正确注入”。
  - **注入语义一致**：对话/动态提示词在 `IN_PROMPT/BEFORE_PROMPT` 也遵循可配置的 role（system/user/assistant），更贴近 ST 的扩展提示词语义。
  - 文件修改：
    - 修改：`src/index.html`
    - 修改：`src/scripts/ui/preset-panel.js`
    - 修改：`src/scripts/ui/bridge.js`
    - 修改：`src/scripts/ui/app.js`

- 2025-12-15 22:53 - 对话解析容错：允许缺失 <content> 包装仍可解析私聊/动态标签
  - **问题**：DeepSeek 偶尔不按提示词输出 `<content>` 包装，导致解析器一直等待 `<content>` 而不解析任何有效标签。
  - **修复**：检测到私聊标签或 `moment_start` 时自动进入解析模式（即使没有 `<content>`），仍按原规则提取私聊与动态内容。
  - 文件修改：
    - 修改：`src/scripts/ui/chat/dialogue-stream-parser.js`

- 2025-12-15 23:00 - 私聊路由容错：标签名无法匹配联系人时回退当前聊天室（不新建）
  - **问题**：模型可能输出别名/繁简体（如「貝法」vs 联系人「贝法」）导致精确匹配失败，私聊消息被当作格式错误丢弃。
  - **修复**：在“从聊天室发起生成”的私聊解析路由中，匹配失败不再丢弃，而是回退写入当前 session（仍不创建新聊天室）。
  - 文件修改：
    - 修改：`src/scripts/ui/app.js`

- 2025-12-15 23:08 - 修复 Tauri invoke 不可用导致存储警告 + 流式超时错误信息
  - **invoke 探测**：统一改用 `globalThis` + `__TAURI_INTERNALS__` 兼容检测，避免在 Android 端出现 `Tauri invoke not available` 导致 `save_kv`/`load_kv` 误判失败（动态/联系人/预设等存储都受影响）。
  - **超时报错**：将 Android WebView 的 `DOMException(AbortError)` 统一转为可读的“请求超时（60秒）”错误，避免日志出现 `[object DOMException]`。
  - 文件修改：
    - 修改：`src/scripts/storage/moments-store.js`
    - 修改：`src/scripts/storage/chat-store.js`
    - 修改：`src/scripts/storage/contacts-store.js`
    - 修改：`src/scripts/storage/config.js`
    - 修改：`src/scripts/storage/regex-store.js`
    - 修改：`src/scripts/storage/preset-store.js`
    - 修改：`src/scripts/storage/worldinfo.js`
    - 修改：`src/scripts/storage/chat.js`
    - 修改：`src/scripts/ui/bridge.js`

- 2025-12-15 23:12 - 支持调整请求超时（上限 5 分钟）
  - **配置面板**：新增「请求超时（秒）」字段（10–300 秒），保存到连接设定档并在发送请求时生效。
  - **错误提示**：超时中止时提示会显示当前配置的秒数（不再固定 60 秒）。
  - 文件修改：
    - 修改：`src/scripts/ui/config-panel.js`
    - 修改：`src/scripts/ui/bridge.js`

- 2025-12-16 00:10 - API 配置体验修复 + Vertex AI 按 ST 方式接入
  - **配置面板不再被切顶**：面板定位改为贴合安全区顶部，内容过长也不会把标题挤出屏幕。
  - **刷新模型不再误报缺 Key**：`刷新列表` 会复用已保存的 Key（遮罩状态下 `apiKey=null` 也能正常拉取模型）。
  - **Vertex AI**：使用 Service Account JSON 通过 WebCrypto 进行 RS256 签名生成 JWT，并通过原生 `http_request` 交换 OAuth2 token；后续调用 Vertex API 同样走原生请求，避免 WebView CORS（实现路径与 SillyTavern 的“后端签名+换 token”一致，只是签名在 WebCrypto 内完成）。
  - 文件修改：
    - 修改：`src/scripts/ui/config-panel.js`
    - 修改：`src/scripts/api/providers/vertexai.js`

- 2025-12-16 00:14 - 修复启动崩溃：config-panel 重复声明导致语法错误
  - **问题**：`populateForm()` 中重复声明 `const timeoutEl`，Android WebView 直接抛 `Uncaught SyntaxError` 导致页面无法加载。
  - **修复**：移除重复代码块。
  - 文件修改：
    - 修改：`src/scripts/ui/config-panel.js`

- 2025-12-16 00:23 - Vertex AI 改进：无需 API Key + 模型列表更完整（分页）
  - **无需 Key**：Vertex AI 使用 Service Account 即可工作；`保存/切换/刷新列表` 不再误判“Key 不可用”，并允许在无 Key 情况下初始化客户端。
  - **模型列表**：`publishers/google/models` 增加 `pageSize=100` + `nextPageToken` 分页抓取；失败时提供更接近 ST 的 10 项 fallback 列表。
  - 文件修改：
    - 修改：`src/scripts/ui/bridge.js`
    - 修改：`src/scripts/ui/config-panel.js`
    - 修改：`src/scripts/ui/preset-panel.js`
    - 修改：`src/scripts/api/providers/vertexai.js`

- 2025-12-16 00:37 - Vertex AI 模型拉全 + 404 自动回退 global + API 配置弹窗层级对齐
  - **模型列表**：移除分页抓取的人工页数上限，改为抓取所有分页；并额外合并 `locations/global` 的模型列表（去重后展示）。
  - **404 回退**：当指定 Region 请求模型返回 404 时，自动用 `locations/global` + `aiplatform.googleapis.com` 重试（用于如 `gemini-3-pro-preview` 这类只在 global 可用的模型）。
  - **UI 层级**：API 配置弹窗的 `z-index` 调整为与预设弹窗一致，避免被覆盖。
  - 文件修改：
    - 修改：`src/scripts/api/providers/vertexai.js`
    - 修改：`src/scripts/ui/config-panel.js`

- 2025-12-16 01:14 - 群组（群聊）基础功能：创建/设置/解析/提示词 + 世界书 A+B
  - **创建群组**：`＋ → 创建群组` 可选择群名/头像/成员并创建群聊入口，自动写入系统消息。
  - **群聊管理**：在群聊内点击标题弹出成员列表（可跳转到成员私聊）并进入群聊设置（名称/头像/成员）。
  - **群聊提示词**：在「预设 → 聊天提示词」新增「群聊提示词」区块（默认折叠），仅在群聊会话注入。
  - **解析群聊回覆**：支持解析 `<群聊:群名字>`（含 `<成员>`/`<聊天内容>`）并把消息分发到对应群聊；若未匹配到已存在群组则丢弃（不自动新建）。
  - **群聊世界书**：构建 prompt 时群聊世界书自动合并为群成员各自私聊世界书（A+B+...），与群成员选择同步。
  - 文件修改：
    - 新增：`src/scripts/ui/group-chat-panels.js`
    - 修改：`src/scripts/storage/contacts-store.js`
    - 修改：`src/scripts/ui/app.js`
    - 修改：`src/scripts/ui/bridge.js`
    - 修改：`src/scripts/ui/preset-panel.js`
    - 修改：`src/scripts/storage/preset-store.js`
    - 修改：`src/scripts/ui/chat/dialogue-stream-parser.js`
    - 修改：`src/scripts/ui/chat/chat-ui.js`
    - 修改：`src/assets/css/qq-legacy.css`
    - 修改：`src/index.html`

- 2025-12-16 10:21 - 群聊/联系人分离展示 + 群聊自动启用群员世界书
  - **联系人界面**：群聊单独显示在「群聊」区域，不参与联系人分组/未分组逻辑（与 `手机流式.html` 一致）。
  - **群聊世界书**：创建/编辑群聊后，若群员存在同名世界书（按成员 id/名称匹配），会自动绑定到对应私聊会话，确保群聊 prompt 合并时能自动启用（A+B+...）。
  - 文件修改：
    - 修改：`src/index.html`
    - 修改：`src/scripts/ui/app.js`
    - 修改：`src/scripts/ui/bridge.js`

- 2025-12-16 10:44 - 联系人页群聊可进入 + 群聊世界书改为“按成员绑定”显示/管理
  - **修复**：联系人页点击群聊现在可正常进入对应群聊会话。
  - **世界书面板（群聊）**：进入群聊后打开世界书，会显示每个成员当前绑定的世界书，并可对成员执行「绑定/更换/停用」；群聊世界书合并逻辑直接使用这些绑定（不依赖世界书名称与成员名称一致）。
  - 文件修改：
    - 修改：`src/scripts/ui/app.js`
    - 修改：`src/scripts/ui/world-panel.js`

- 2025-12-16 10:47 - 修复启动崩溃：WorldPanel 初始化时引用未定义变量
  - **问题**：`app.js` 中在 `contactsStore/chatStore` 初始化之前创建 `WorldPanel`，导致 `ReferenceError: Cannot access 'contactsStore' before initialization`。
  - **修复**：调整初始化顺序，先创建 store，再创建 `WorldPanel`。
  - 文件修改：
    - 修改：`src/scripts/ui/app.js`

- 2025-12-16 11:08 - 聊天提示词按场景拆分（私聊/群聊/动态评论）并与手机流式构建一致
  - **预设 → 聊天提示词**：将原“动态提示词”拆分为「动态发布决策提示词」与「动态评论回覆提示词」两块。
  - **场景注入规则**：
    - A 私聊：仅注入「私聊提示词」+「动态发布决策提示词」
    - B 群聊：仅注入「群聊提示词」+「动态发布决策提示词」
    - C 动态评论：仅注入「动态评论回覆提示词」
  - **动态评论生成**：评论任务不再在 `app.js` 内硬编码规则，改为通过 `task: moment_comment` 触发预设注入（只传数据）。
  - 文件修改：
    - 修改：`src/scripts/ui/bridge.js`
    - 修改：`src/scripts/ui/preset-panel.js`
    - 修改：`src/scripts/storage/preset-store.js`
    - 修改：`src/scripts/ui/app.js`

- 2025-12-16 11:33 - 补全“手机格式提示词”世界书条目并按原顺序注入
  - **内置世界书迁移**：从 `手机流式.html` 完整搬运 `手机-格式1-格式开头`、`手机-格式2-QQ聊天`、`手机-格式3-QQ空间`、`手机-格式999-格式结尾`、`手机-界面基本设置`（保留深度/关键词/顺序等元数据）。
  - **自动写入/更新**：App 启动时自动确保存在内置世界书 `手机-格式`（用于补齐缺失/不完整条目）。
  - **注入与排序**：世界书注入改为按 `order/priority` 升序拼接，并支持 `constant/disable/关键词` 的基础触发（无 matchText 时保持旧行为：全部启用条目可见）。
  - 文件修改：
    - 新增：`src/scripts/storage/builtin-worldbooks.js`
    - 修改：`src/scripts/ui/bridge.js`

- 2025-12-16 11:54 - 预设聊天提示词去重：保留场景判别，格式说明交给世界书
  - **决策**：场景判别（私聊/群聊/动态评论）继续由预设/应用侧注入负责；“手机格式提示词”（QQ聊天/QQ空间/收尾）统一由世界书 `手机-格式*` 提供。
  - **默认提示词精简**：将预设中的 `<QQ聊天格式介绍>` / `<QQ空间格式介绍>` 等重复格式说明从默认值中移除，仅保留风格与场景信息；旧版内容保留在源码注释中便于对照。
  - **迁移**：若用户仍使用旧默认提示词（包含 `<QQ聊天格式介绍>` 或 `<QQ空间格式介绍>` / `<content>` 约束），启动时会自动替换为精简版默认值（不影响已自定义内容）。
  - 文件修改：
    - 修改：`src/scripts/storage/preset-store.js`

- 2025-12-16 15:53 - 联系人页“搜索联系人…”按手机流式实现
  - **搜索交互**：支持输入防抖、清除按钮、焦点高亮、Esc 清空（参照 `手机流式.html` 的 `initContactSearch/filterContacts`）。
  - **过滤范围**：按“联系人名称 + 最后一条消息预览”匹配，分区（群聊/未分组联系人）无匹配时自动隐藏分区；清空搜索恢复。
  - **高亮**：匹配到的名称/预览会高亮显示，并在刷新联系人列表后保持过滤状态。
  - 文件修改：
    - 修改：`src/index.html`
    - 修改：`src/assets/css/main.css`
    - 修改：`src/scripts/ui/app.js`

- 2025-12-16 23:20 - 修复启动后连接配置回退：不再被“预设绑定连接”覆盖
  - **问题**：启动时 `AppBridge.init()` 会根据预设的 `boundProfileId` 强制切换连接，导致用户明明保存并正在使用 Deepseek，重启后又被切回旧的默认/其他配置。
  - **修复**：启动时不再用预设绑定覆盖“最后一次使用的连接配置”；预设绑定仅在用户切换预设时应用（由 `preset-panel` 触发）。
  - 文件修改：
    - 修改：`src/scripts/ui/bridge.js`
- 2025-12-16 17：45
  - 实现联系人分组完整功能：新增 group-store.js（分组存储）、group-panel.js（分组管理面板）、contact-drag-manager.js（拖拽管理）、contact-group-renderer.js（分组渲染）。
  - 新增 contact-groups.css 样式文件，支持分组折叠/展开、拖拽放置区高亮、拖拽状态反馈。
  - 修改 app.js：集成 GroupStore、ContactDragManager、GroupPanel、ContactGroupRenderer；修改 renderContactsUngrouped 使用分组渲染；连接快捷菜单「新建分组」按钮。
  - 修改 index.html：引入 contact-groups.css。
  - 功能完整度：✅ 创建分组、✅ 重命名分组、✅ 删除分组、✅ 折叠/展开、✅ 拖拽联系人到分组、✅ 拖拽到未分组区域、✅ 数据持久化（localStorage + Tauri KV）。
  - 新增文档：CONTACT_GROUPS_IMPLEMENTATION.md（详细实现说明、使用指南、测试建议）。
  - 参考原文件：手机流式.html 第 32729-33428 行分组功能实现。
- 2025-12-16 18：40（配置加载修复）
  - 修复 API 配置在重新打开 APP 时自动切换到错误配置的问题。
  - 问题原因：ensureStores() 在 activeProfileId 无效时，按插入顺序选择第一个配置，而不是按最后使用时间。
  - 修复方案：1) 确保 activeProfileId 字段存在（防止 undefined）；2) 按 updatedAt 降序选择最近使用的配置；3) 添加调试日志。
  - 修改文件：src/scripts/storage/config.js（ensureStores、load、save、setActiveProfile 方法）。
  - 新增文档：CONFIG_LOAD_FIX.md（详细说明问题、修复方案、验证步骤）。
  - 现在每次打开 APP 时，会自动加载最后一次保存/使用的配置，而不是第一个创建的配置。
- 2025-12-16 19：35（Android 配置调试工具）
  - 为 Android 设备添加屏幕调试面板，无需连接电脑即可查看日志。
  - 新增文件：src/scripts/ui/debug-panel.js（屏幕调试面板，右下角 DEBUG 按钮切换）。
  - 修改 src/scripts/utils/logger.js：所有 INFO/WARN/ERROR 日志同时输出到调试面板。
  - 修改 src/scripts/storage/config.js：增强持久化和加载日志，显示 activeProfileId 和配置数量。
  - 修改 src/scripts/ui/config-panel.js：添加「调试信息」按钮，显示当前配置状态和 localStorage 数据。
  - 调试面板功能：显示实时日志（最多20条）、支持显示配置状态、按时间戳显示、颜色区分日志级别。
  - persistProfiles 方法改进：显式保存 activeProfileId 和 profiles 字段，同时保存到 Tauri KV 和 localStorage。
  - 新增文档：DEBUG_CONFIG_ANDROID.md（详细的 Android 调试指南、使用方法、问题诊断步骤）。
- 2025-12-16 22：30（按钮布局优化和配置切换防护）
  - 修复 API 配置面板底部按钮布局不美观的问题。
  - 修改 src/scripts/ui/config-panel.js：将「调试信息」按钮改为小按钮独立放置在上方，主要操作按钮（测试连接、取消、保存）统一样式和大小，右对齐排列。
  - 按钮样式改进：统一 padding、border-radius、min-width，使用更柔和的颜色（#e2e8f0 边框、#f8fafc 背景）。
  - 修改 src/scripts/ui/debug-panel.js：APP 启动时自动显示调试面板 8 秒，让用户能看到配置加载日志；增加 maxLogs 到 30 条；增强 showConfigStatus 显示每个配置的最后修改时间。
  - 防止配置意外切换：添加 isRefreshingProfile 标志，防止刷新配置选择器时触发 onchange 事件导致配置被意外切换。
  - 增强日志：在配置选择器 onchange 中添加日志，记录用户手动切换配置的操作。

- 2025-12-16 23:10（Tauri KV 持久化增强 - Android fsync 和详细日志）
  - **问题发现**：通过用户截图确认根本原因 - 保存的 activeProfileId（profile-1765814569599-2f6ecb，Vertex）与重新打开后加载的 activeProfileId（profile-1765817736355-18596b，Deepseek）完全不同，说明 Tauri KV 存储没有正确持久化数据。
  - **修复方案**：
    - 修复：Android 文件系统同步 (`fsync`) 确保 activeProfileId 正确落盘。
- 2025-12-16 23:45（性能优化 - 解决 Android 输入卡顿）
  - **问题诊断**：手机端输入时严重卡顿，原因定位为 CSS `backdrop-filter` 导致的 GPU 过载，以及 `input` 事件触发高频同步 `localStorage` 写入。
  - **CSS 优化**：移除 `qq-legacy.css` 和 `main.css` 中所有 `backdrop-filter: blur(...)`，改用纯半透明背景，大幅降低 GPU 渲染压力。
  - **JS 优化**：在 `chat-ui.js` 的 `onInputChange` 中增加 500ms 防抖 (Debounce)，避免每输入一个字符就触发一次磁盘写入/序列化，释放主线程资源。
- 2025-12-17 00:30（功能增强 - 历史记录与世界书管理）
  - **输入框优化**：将单行 `input` 替换为多行 `textarea`，支持自动换行与高度自适应，并隐藏了滚动条以保持美观。
  - **消息交互**：长按菜单新增「复制」；「编辑」改为原地编辑（Inline Edit），体验更流畅。
  - **世界书管理**：列表项新增「删除」按钮，可直接删除已保存的世界书。
  - **聊天分支管理**：好友设置界面新增「聊天管理」区块，支持「开启新聊天」（自动存档当前记录）与「加载历史存档」，实现类似 ST 的多分支对话切换。
  - **新聊天逻辑优化**：
    - 「开启新聊天」时强制新建存档（即使当前已关联存档也作为快照保存），防止覆盖旧版本。
    - 存档命名自动追加时间戳后缀（防止混淆）。
    - 切换存档时自动保存当前编辑进度（更新现有存档或新建自动存档）。
    - 历史列表中高亮显示当前正在编辑的存档。
- 2025-12-17 01:15（核心逻辑 - 变量与宏引擎）
  - **Macro Engine**：实现 `src/scripts/utils/macro-engine.js`，支持多轮解析与常用指令（`setvar`、`getvar`、`incvar`、`random`、`dice` 等）。
  - **后端集成**：`ChatStore` 增加变量存储支持；`AppBridge` 集成宏引擎，并在构建 Prompt 时自动处理所有文本（规则、世界书、Prompt Blocks）。
  - **功能落地**：现在 Prompt 中的 `{{...}}` 将会被动态替换，支持类似 SillyTavern 的高级逻辑与状态记忆。
    - 为 `save_kv` 和 `load_kv` 命令添加详细的终端日志（eprintln），显示文件路径、数据大小、activeProfileId 和 profiles 数量。
  - **修改文件**：
    - `src-tauri/src/commands.rs` (save_kv 函数)：添加 fsync() 调用和日志输出
    - `src-tauri/src/commands.rs` (load_kv 函数)：添加详细的加载日志
  - **测试方法**：
    - 重新编译 Android APK：`npm run tauri android build`
    - 在终端运行 `npm run dev` 并在手机上打开 APP，观察终端输出的 [save_kv] 和 [load_kv] 日志
    - 保存配置时记录 activeProfileId，关闭 APP 后重新打开，确认加载的 activeProfileId 是否一致
  - **预期结果**：fsync() 确保数据立即写入磁盘，解决 Android 文件系统缓存导致的数据丢失问题。
